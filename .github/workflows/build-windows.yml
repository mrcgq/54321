# GitHub Actions Workflow 的名称
name: Build Xlink Windows Client

# 触发工作流程的事件
on:
  push:
    branches: [ "main" ]
  release:
    types: [published]
  workflow_dispatch:

# 定义工作流程中的任务 (Jobs)
jobs:
  build:
    # 指定运行此任务的虚拟机环境
    runs-on: windows-latest

    # 定义任务中的步骤 (Steps)
    steps:
      # 步骤 1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: 设置 Node.js 环境 (前端构建需要)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 步骤 3: 设置 Go 环境 (后端构建需要)
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          # 缓存依赖以加快构建速度
          cache: true 

      # 步骤 4: 直接安装 Wails CLI 工具 (最稳妥的方式)
      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      # 步骤 5: 构建 Wails 应用程序
      - name: Build Wails application
        # 此时 wails 已经安装到环境变量中了，直接调用
        run: wails build -platform windows/amd64 -ldflags "-H windowsgui -s -w"

      # 步骤 6: 准备打包资源 (处理内核文件)
      - name: Prepare packaging resources
        run: |
          # 创建 release 目录
          if (-not (Test-Path release)) { mkdir release }
          
          # 复制构建好的 exe
          Copy-Item build/bin/xlink-client.exe -Destination release/
          
          # --- ⚠️⚠️⚠️ 关键修改：内核文件下载 ⚠️⚠️⚠️ ---
          # 这里的 URL 必须替换成您真实有效的直链！
          # 如果您暂时没有上传，为了防止构建报错，我先注释掉了下载命令。
          # 等您上传了 Release Assets 后，请取消注释并填入真实 URL。
          
          echo "Downloading runtime resources (Skipped for now, please configure URLs)..."
          
          # iwr -Uri "https://github.com/mrcgq/54321/releases/download/v0.0.1/xlink-cli-binary.exe" -OutFile "release/xlink-cli-binary.exe"
          # iwr -Uri "https://github.com/mrcgq/54321/releases/download/v0.0.1/xray.exe" -OutFile "release/xray.exe"
          # iwr -Uri "https://github.com/mrcgq/54321/releases/download/v0.0.1/wintun.dll" -OutFile "release/wintun.dll"
          # iwr -Uri "https://github.com/mrcgq/54321/releases/download/v0.0.1/geosite.dat" -OutFile "release/geosite.dat"
          # iwr -Uri "https://github.com/mrcgq/54321/releases/download/v0.0.1/geoip.dat" -OutFile "release/geoip.dat"

          echo "Listing files in release folder:"
          ls release/

      # 步骤 7: 将打包文件压缩成 ZIP
      - name: Create ZIP archive
        run: |
          Compress-Archive -Path release\* -DestinationPath xlink-client-windows-amd64.zip

      # 步骤 8: 上传构建产物
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: xlink-client-windows-amd64
          path: xlink-client-windows-amd64.zip
