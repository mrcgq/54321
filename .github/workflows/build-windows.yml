# GitHub Actions Workflow 的名称
name: Build Xlink Windows Client (Release)

# 触发工作流程的事件
on:
  push:
    branches: [ "main" ]
  release:
    types: [published]
  workflow_dispatch:

# 定义工作流程中的任务 (Jobs)
jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true 

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      # ⚠️【关键修改】切换回生产模式构建
      # -H windowsgui: 隐藏黑色的控制台窗口
      # -s -w: 减小体积，去除调试符号
      - name: Build Wails application
        run: wails build -platform windows/amd64 -ldflags "-H windowsgui -s -w"

      - name: Prepare packaging resources
        run: |
          if (-not (Test-Path release)) { mkdir release }
          Copy-Item build/bin/xlink-client.exe -Destination release/
          
          # 注意：为了让软件能用，请在这里填入内核文件的下载链接，或者构建完自己手动放进去
          echo "Downloading runtime resources (Skipped)..."
          
          echo "Listing files in release folder:"
          ls release/

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path release\* -DestinationPath xlink-client-windows-amd64.zip

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: xlink-client-windows-amd64
          path: xlink-client-windows-amd64.zip
