# GitHub Actions Workflow 的名称
name: Build Xlink Windows Client

# 触发工作流程的事件
on:
  # 1. 当代码推送到 main 分支时触发
  push:
    branches: [ "main" ]
  # 2. 当发布一个以 "v" 开头的标签时触发 (例如 v1.0.0)
  release:
    types: [published]
  # 3. 允许在 GitHub Actions 页面手动触发此工作流程
  workflow_dispatch:

# 定义工作流程中的任务 (Jobs)
jobs:
  # 只有一个任务，名为 "build"
  build:
    # 指定运行此任务的虚拟机环境
    runs-on: windows-latest # 使用最新的 Windows 环境

    # 定义任务中的步骤 (Steps)
    steps:
      # 步骤 1: 检出代码
      # 使用官方的 actions/checkout@v4 操作来获取你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: 设置 Wails 环境
      # 这是最关键的一步，使用 Wails 官方提供的 Action
      # 它会自动：
      # - 安装 Go
      # - 安装 Node.js / npm
      # - 安装 Wails CLI
      # - 安装 Windows 构建所需的依赖 (WebView2, CGO 工具链等)
      - name: Setup Wails environment
        uses: wailsapp/wails-action@v2
        with:
          # 指定要安装的 Wails CLI 版本，建议与你本地开发版本保持一致
          wails-version: 'v2.8.0' 
          # 指定 Go 版本
          go-version: '1.21'
          # 指定 NSIS 版本，用于创建安装程序 (可选)
          nsis-version: '3.08'

      # 步骤 3: 构建 Wails 应用程序
      # -platform windows/amd64 指定构建 Windows 64位版本
      # -ldflags "-H windowsgui" 用于隐藏 Windows 上的命令行窗口
      - name: Build Wails application
        run: wails build -platform windows/amd64 -ldflags "-H windowsgui -s -w"

      # 步骤 4: 准备打包资源 (处理内核文件)
      # 因为你不把内核文件放在仓库里，所以我们需要在构建时下载它们
      - name: Prepare packaging resources
        run: |
          # 创建一个目录来存放最终的打包文件
          mkdir release
          
          # 将构建好的 exe 复制到 release 目录
          cp build/bin/xlink-client.exe release/
          
          # --- 关键部分：下载运行时资源 ---
          # 你需要将你的内核文件上传到一个稳定的下载地址 (例如 GitHub Release 的 Assets)
          # 然后在这里用 PowerShell 的 Invoke-WebRequest (iwr) 命令下载它们
          # 下面的 URL 都是占位符，请替换为你自己的实际下载链接！
          
          echo "Downloading runtime resources..."
          iwr -Uri "https://YOUR_DOWNLOAD_LINK/xlink-cli-binary.exe" -OutFile "release/xlink-cli-binary.exe"
          iwr -Uri "https://YOUR_DOWNLOAD_LINK/xray.exe" -OutFile "release/xray.exe"
          iwr -Uri "https://YOUR_DOWNLOAD_LINK/wintun.dll" -OutFile "release/wintun.dll"
          iwr -Uri "https://YOUR_DOWNLOAD_LINK/geosite.dat" -OutFile "release/geosite.dat"
          iwr -Uri "https://YOUR_DOWNLOAD_LINK/geoip.dat" -OutFile "release/geoip.dat"

          echo "Resources downloaded."

      # 步骤 5: 将打包文件压缩成 ZIP
      - name: Create ZIP archive
        run: |
          # 使用 PowerShell 的 Compress-Archive 命令创建 zip 文件
          Compress-Archive -Path release\* -DestinationPath xlink-client-windows-amd64.zip

      # 步骤 6: 上传构建产物 (Artifact)
      # 这样你就可以在 Actions 页面下载这个 zip 文件了
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          # 上传的产物名称
          name: xlink-client-windows-amd64
          # 要上传的文件路径
          path: xlink-client-windows-amd64.zip
